{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS WAF v2 Configuration for NoraHub Application Security",
  "Resources": {
    "NoraHubWebACL": {
      "Type": "AWS::WAFv2::WebACL",
      "Properties": {
        "Name": "NoraHubSecurityWAF",
        "Scope": "CLOUDFRONT",
        "Description": "WAF para proteger NoraHub contra ataques comuns",
        "DefaultAction": {
          "Allow": {}
        },
        "Rules": [
          {
            "Name": "AWSManagedRulesCommonRuleSet",
            "Priority": 0,
            "OverrideAction": {
              "None": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesCommonRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesCommonRuleSetMetric"
            }
          },
          {
            "Name": "AWSManagedRulesKnownBadInputsRuleSet",
            "Priority": 1,
            "OverrideAction": {
              "None": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesKnownBadInputsRuleSetMetric"
            }
          },
          {
            "Name": "AWSManagedRulesSQLiRuleSet",
            "Priority": 2,
            "OverrideAction": {
              "None": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesSQLiRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesSQLiRuleSetMetric"
            }
          },
          {
            "Name": "RateLimitRule",
            "Priority": 3,
            "Action": {
              "Block": {
                "CustomResponse": {
                  "ResponseCode": 429,
                  "CustomResponseBodyKey": "TooManyRequests"
                }
              }
            },
            "Statement": {
              "RateBasedStatement": {
                "Limit": 2000,
                "AggregateKeyType": "IP"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "RateLimitRuleMetric"
            }
          },
          {
            "Name": "GeoBlockRule",
            "Priority": 4,
            "Action": {
              "Block": {}
            },
            "Statement": {
              "NotStatement": {
                "Statement": {
                  "GeoMatchStatement": {
                    "CountryCodes": ["BR", "US", "CA", "GB", "DE", "FR", "ES", "PT", "AR", "CL", "CO", "MX"]
                  }
                }
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "GeoBlockRuleMetric"
            }
          },
          {
            "Name": "BlockCommonAttackPatterns",
            "Priority": 5,
            "Action": {
              "Block": {}
            },
            "Statement": {
              "OrStatement": {
                "Statements": [
                  {
                    "ByteMatchStatement": {
                      "SearchString": "../",
                      "FieldToMatch": {
                        "UriPath": {}
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "URL_DECODE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "<script",
                      "FieldToMatch": {
                        "Body": {}
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "eval(",
                      "FieldToMatch": {
                        "Body": {}
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  }
                ]
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "BlockCommonAttackPatternsMetric"
            }
          }
        ],
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "NoraHubWebACLMetric"
        },
        "CustomResponseBodies": {
          "TooManyRequests": {
            "ContentType": "APPLICATION_JSON",
            "Content": "{\"error\": \"Too many requests. Please try again later.\"}"
          }
        }
      }
    },
    "WAFLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/aws/waf/norahub",
        "RetentionInDays": 30
      }
    },
    "WAFLoggingConfiguration": {
      "Type": "AWS::WAFv2::LoggingConfiguration",
      "Properties": {
        "ResourceArn": {
          "Fn::GetAtt": ["NoraHubWebACL", "Arn"]
        },
        "LogDestinationConfigs": [
          {
            "Fn::GetAtt": ["WAFLogGroup", "Arn"]
          }
        ],
        "RedactedFields": [
          {
            "SingleHeader": {
              "Name": "authorization"
            }
          },
          {
            "SingleHeader": {
              "Name": "cookie"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "WebACLId": {
      "Description": "ID do Web ACL criado",
      "Value": {
        "Fn::GetAtt": ["NoraHubWebACL", "Id"]
      }
    },
    "WebACLArn": {
      "Description": "ARN do Web ACL criado",
      "Value": {
        "Fn::GetAtt": ["NoraHubWebACL", "Arn"]
      }
    }
  }
}
